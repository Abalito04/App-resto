{% extends "base.html" %}
{% block content %}
<div class="container mt-4" style="max-width:480px">
  <h3>{{ _('Ingresar') }}</h3>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for c,m in messages %}
      <div class="alert alert-{{ 'danger' if c=='error' else c }}">{{ m }}</div>
    {% endfor %}
  {% endwith %}
  <form method="POST">
    <div class="mb-3">
      <label>{{ _('Email') }}</label>
      <input class="form-control" type="email" name="email" value="{{ pending_email or '' }}" required>
    </div>
    <div class="mb-3">
      <label>{{ _('Contrase√±a') }}</label>
      <input class="form-control" type="password" name="password" required>
    </div>
    <button class="btn btn-primary w-100" type="submit">{{ _('Entrar') }}</button>
  </form>
  <div class="text-center mt-3">
    <a href="{{ url_for('auth.resend_confirm') }}">{{ _('¬øNo recibiste el email de confirmaci√≥n?') }}</a>
  </div>
</div>

<!-- EmailJS para env√≠o de emails de confirmaci√≥n -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script type="text/javascript">
  // Inicializar EmailJS
  (function() {
    emailjs.init("79cmvTkckyQwZrWM7"); // Reemplazar con tu clave p√∫blica de EmailJS
  })();

  // Funci√≥n para enviar email de confirmaci√≥n
  function sendConfirmationEmail(email, token) {
    console.log('Iniciando env√≠o de email para:', email, 'con token:', token);
    
    // Obtener datos del email desde el servidor
    fetch(`/auth/email_data/${token}`)
      .then(response => {
        console.log('Respuesta del servidor:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Datos recibidos:', data);
        if (data.error) {
          console.error('Error obteniendo datos del email:', data.error);
          showEmailError();
          return;
        }

        // Configurar template de EmailJS - versi√≥n corregida
        const templateParams = {
          to_email: data.email,
          to_name: data.nombre || 'Usuario',
          confirm_url: data.confirm_url,
          restaurante: data.restaurante || 'Nuevo Restaurante',
          from_name: 'Sistema de Restaurantes',
          // Par√°metros adicionales que EmailJS podr√≠a requerir
          reply_to: data.email,
          user_email: data.email
        };
        
        // Verificar que todos los par√°metros requeridos est√©n presentes
        console.log('=== DIAGN√ìSTICO EMAILJS ===');
        console.log('Credenciales:');
        console.log('- Service ID: service_yj1mcpr');
        console.log('- Template ID: template_mg7eult');
        console.log('- Public Key: 79cmvTkckyQwZrWM7');
        console.log('');
        console.log('Par√°metros enviados:');
        console.log('- to_email:', templateParams.to_email);
        console.log('- to_name:', templateParams.to_name);
        console.log('- confirm_url:', templateParams.confirm_url);
        console.log('- restaurante:', templateParams.restaurante);
        console.log('- from_name:', templateParams.from_name);
        console.log('- reply_to:', templateParams.reply_to);
        console.log('- user_email:', templateParams.user_email);
        console.log('');

        console.log('Enviando email con par√°metros:', templateParams);

        // Enviar email usando EmailJS
        emailjs.send('service_yj1mcpr', 'template_mg7eult', templateParams)
          .then(function(response) {
            console.log('‚úÖ Email enviado exitosamente:', response.status, response.text);
            showEmailSentMessage();
          }, function(error) {
            console.error('‚ùå Error enviando email:', error);
            console.error('Detalles del error:', {
              status: error.status,
              text: error.text,
              message: error.message
            });
            
            // Intentar con par√°metros m√≠nimos como fallback
            console.log('üîÑ Intentando con par√°metros m√≠nimos...');
            const minimalParams = {
              to_email: data.email,
              to_name: 'Usuario',
              confirm_url: data.confirm_url
            };
            
            emailjs.send('service_yj1mcpr', 'template_mg7eult', minimalParams)
              .then(function(response) {
                console.log('‚úÖ Email enviado con par√°metros m√≠nimos:', response.status, response.text);
                showEmailSentMessage();
              }, function(error2) {
                console.error('‚ùå Error tambi√©n con par√°metros m√≠nimos:', error2);
                showEmailError();
              });
          });
      })
      .catch(error => {
        console.error('Error en la petici√≥n:', error);
        showEmailError();
      });
  }

  // Mostrar mensaje de email enviado
  function showEmailSentMessage() {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success mt-3';
    alertDiv.innerHTML = '‚úÖ Email de confirmaci√≥n enviado exitosamente. Revisa tu correo.';
    document.querySelector('.container').appendChild(alertDiv);
  }

  // Mostrar mensaje de error
  function showEmailError() {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-warning mt-3';
    alertDiv.innerHTML = '‚ö†Ô∏è No se pudo enviar el email autom√°ticamente. Usa el enlace de reenv√≠o.';
    document.querySelector('.container').appendChild(alertDiv);
  }

  // Verificar si hay un token en la URL (despu√©s del registro)
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');
  const email = urlParams.get('email');
  
  if (token && email) {
    // Enviar email autom√°ticamente despu√©s del registro
    sendConfirmationEmail(email, token);
  }
</script>
{% endblock %}
