<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RestÃ³ App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#f3b927">

    <!-- Manifest PWA -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- Estilos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- PWA iOS Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="RestÃ³ App">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-192.png') }}">
</head>

<body>
    <header>
        <div class="d-flex justify-content-between align-items-center p-3 bg-dark text-white">
            <h1>ğŸ½ï¸ RestÃ³ App</h1>
            
            <!-- BotÃ³n de notificaciones -->
            <button id="enable-notifications" class="btn btn-warning btn-sm" style="display: none;">
                ğŸ”” Habilitar Notificaciones
            </button>
        </div>
        
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="{{ url_for('index') }}">ğŸ“ Mozo</a>
                <a class="navbar-brand" href="{{ url_for('cocina') }}">ğŸ‘¨â€ğŸ³ Cocina</a>
                <a class="navbar-brand" href="{{ url_for('historial') }}">ğŸ“œ Historial</a>
                
                <!-- Estado PWA -->
                <span id="pwa-status" class="badge bg-secondary ms-auto">ğŸ”Œ Conectado</span>
            </div>
        </nav>
    </header>
    
    <main class="container my-3">
        {% block content %}{% endblock %}
    </main>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // === Registro del Service Worker ===
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", async () => {
            try {
                const registration = await navigator.serviceWorker.register("{{ url_for('static', filename='sw.js') }}");
                console.log("âœ… ServiceWorker registrado:", registration.scope);

                // Mostrar botÃ³n de notificaciones si no estÃ¡n habilitadas
                if (Notification.permission === "default") {
                    document.getElementById("enable-notifications").style.display = "block";
                }

            } catch (error) {
                console.error("âŒ Error registrando ServiceWorker:", error);
            }
        });

        // Escuchar mensajes del SW (actualizaciones de cachÃ©, etc.)
        navigator.serviceWorker.addEventListener("message", event => {
            if (event.data && event.data.type === "CACHE_UPDATED") {
                console.log("ğŸ”„ AplicaciÃ³n actualizada");
            }
        });
    }

    // === Estado de conexiÃ³n ===
    function updateConnectionStatus() {
        const statusElement = document.getElementById("pwa-status");
        if (navigator.onLine) {
            statusElement.textContent = "ğŸ”Œ Conectado";
            statusElement.className = "badge bg-success ms-auto";
        } else {
            statusElement.textContent = "ğŸ“¡ Sin conexiÃ³n";
            statusElement.className = "badge bg-warning ms-auto";
        }
    }
    window.addEventListener("online", updateConnectionStatus);
    window.addEventListener("offline", updateConnectionStatus);
    updateConnectionStatus();

    // === InstalaciÃ³n como PWA ===
    let deferredPrompt;
    window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;

        // Crear botÃ³n dinÃ¡mico de instalaciÃ³n
        const installButton = document.createElement("button");
        installButton.textContent = "ğŸ“± Instalar App";
        installButton.className = "btn btn-primary btn-sm ms-2";
        installButton.onclick = async () => {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Usuario ${outcome} la instalaciÃ³n`);
            deferredPrompt = null;
            installButton.remove();
        };

        document.querySelector("header .d-flex").appendChild(installButton);
    });

    window.addEventListener("appinstalled", () => {
        console.log("ğŸ‰ PWA instalada correctamente");
        deferredPrompt = null;
    });
    </script>
</body>
</html>
