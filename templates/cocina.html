{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>üßë‚Äçüç≥ Cocina - Pedidos activos</h2>
    <div class="row">
    {% for item in lista_pedidos %}
        {% if item.pedido.estado != "Entregado" %}
        <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="card shadow-sm p-2" data-hora="{{ item.pedido.hora_cocina.isoformat() if item.pedido.hora_cocina else "" }}">
                <strong>
                {% if item.pedido.tipo_consumo == "Local" %}
                    Mesa {{ item.pedido.mesa }}
                {% else %}
                    Para llevar: {{ item.pedido.nombre_cliente }}
                {% endif %}
                </strong> - {{ item.pedido.metodo_pago }}
                <small class="d-block">Fecha: {{ item.pedido.fecha.strftime('%d/%m/%Y %H:%M') }} ({{ zona_horaria }})</small>

                <small class="d-block text-danger">‚è± Tiempo en cocina: <span class="tiempo">0m 0s</span></small>

                <ul class="list-group list-group-flush mt-2 mb-2">
                    {% for it in item.pedido.items %}
                        <li class="list-group-item p-1">
                            {% if it.cantidad > 1 %}
                                {{ it.cantidad }}x {{ it.producto.nombre }}
                            {% else %}
                                {{ it.producto.nombre }}
                            {% endif %}
                            - ${{ it.producto.precio * it.cantidad }}
                        </li>
                    {% endfor %}
                </ul>
                <strong>Total: ${{ item.pedido.total }}</strong>

                <div class="d-flex gap-2 mt-2">
                    <form method="POST" action="{{ url_for('entregado', pedido_id=item.pedido.id) }}">
                        <button class="btn btn-success btn-sm">‚úÖ Entregado</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    {% else %}
        <p>No hay pedidos pendientes.</p>
    {% endfor %}
    </div>
</div>

<!-- Script para actualizar tiempo en vivo -->
<script>
function actualizarTiempos() {
    document.querySelectorAll('.card').forEach(card => {
        const horaStr = card.dataset.hora;
        if (!horaStr) return;
        
        const hora = new Date(horaStr);
        const ahora = new Date();
        
        // Calcular diferencia en segundos
        const diff = Math.floor((ahora - hora) / 1000);
        
        // Si la diferencia es negativa, mostrar 0
        if (diff < 0) {
            card.querySelector('.tiempo').textContent = '0m 0s';
            return;
        }
        
        const minutos = Math.floor(diff / 60);
        const segundos = diff % 60;
        card.querySelector('.tiempo').textContent = `${minutos}m ${segundos}s`;
    });
}

// Actualiza cada segundo
setInterval(actualizarTiempos, 1000);
actualizarTiempos();
</script>
{% endblock %}
