{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>üìù Tomar pedido</h2>

    <!-- FORMULARIO PARA NUEVO PEDIDO -->
    <form method="POST" action="{{ url_for('crear_pedido') }}">
        <div class="mb-3">
            <label for="mesa" class="form-label">Mesa:</label>
            <input type="text" class="form-control" id="mesa" name="mesa" required>
        </div>

        <h4>Productos:</h4>
        {% for producto in productos %}
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="prod{{ producto.id }}" name="producto" value="{{ producto.id }}">
            <label class="form-check-label" for="prod{{ producto.id }}">
                {{ producto.nombre }} - ${{ producto.precio }}
            </label>
        </div>
        {% endfor %}

        <div class="mt-3">
            <label for="metodo_pago" class="form-label">M√©todo de pago:</label>
            <select class="form-select" id="metodo_pago" name="metodo_pago" required>
                <option value="Efectivo">Efectivo</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Deuda">Deuda</option>
            </select>
        </div>

        <br>
        <button type="submit" class="btn btn-primary">Agregar pedido</button>
    </form>

    <hr>

    <!-- LISTA DE PEDIDOS ACTIVOS -->
    <h3>Pedidos activos:</h3>
    {% for pedido in pedidos %}
    <div class="card mb-2 shadow-sm p-2">
        <strong>Mesa {{ pedido.mesa }}</strong> - 
        Pago: <span class="badge bg-info">{{ pedido.metodo_pago }}</span> - 
        Tiempo transcurrido: <span id="timer-{{ pedido.id }}"></span>

        <ul class="mb-1 mt-2">
            {% for item in pedido.items %}
                <li>{{ item.producto.nombre }} - ${{ item.producto.precio }}</li>
            {% endfor %}
        </ul>

        <strong>Total: ${{ pedido.items | sum(attribute='producto.precio') }}</strong>

        <!-- Botones de acci√≥n -->
        <div class="d-flex gap-2 mt-2">
            <form method="POST" action="{{ url_for('borrar_pedido', pedido_id=pedido.id) }}">
                <button class="btn btn-danger btn-sm">üóë Borrar</button>
            </form>
            <a href="{{ url_for('editar_pedido', pedido_id=pedido.id) }}" class="btn btn-warning btn-sm">‚úè Editar</a>
            <form method="POST" action="{{ url_for('entregado', pedido_id=pedido.id) }}">
                <button class="btn btn-success btn-sm">‚úÖ Entregado</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>

<!-- üöÄ Script para timers -->
<script>
function startTimersMozo() {
    {% for pedido in pedidos %}
    (function(){
        const start = new Date("{{ pedido.fecha.isoformat() }}");
        const timerEl = document.getElementById("timer-{{ pedido.id }}");
        setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - start) / 1000); // en segundos
            const mins = Math.floor(diff / 60);
            const secs = diff % 60;
            timerEl.textContent = mins + "m " + (secs < 10 ? "0" : "") + secs + "s";
        }, 1000);
    })();
    {% endfor %}
}
window.onload = startTimersMozo;
</script>
{% endblock %}
